import { Engine } from "./engine.js";
import { renderQuestion, updateNav } from "./ui.js";

const el = {
  testSelect: document.getElementById("testSelect"),
  sectionSelect: document.getElementById("sectionSelect"),
  qnav: document.getElementById("qnav"),
  question: document.getElementById("question"),
  prevBtn: document.getElementById("prevBtn"),
  nextBtn: document.getElementById("nextBtn"),
  submitBtn: document.getElementById("submitBtn"),
  resetBtn: document.getElementById("resetBtn"),
  status: document.getElementById("status"),
  results: document.getElementById("results"),
  timer: document.getElementById("timer"),
  frame: document.getElementById("pdfFrame")
};

let engine = null;
let currentTest = null;
let manifest = null;

/* ---------------------------
   Load passage HTML per section
---------------------------- */
function loadSectionMaterial(sectionIndex) {
  if (!el.frame || !currentTest) return;

  const material =
    currentTest.sections?.[sectionIndex]?.materialHtml;

  if (!material) {
    el.frame.removeAttribute("src");
    return;
  }

  // reading.html lives in /pages/, assets are one level up
  el.frame.src = `../${material}`;
}

/* ---------------------------
   Load test JSON
---------------------------- */
async function loadTest(path) {
  const res = await fetch(`../${path}`);
  currentTest = await res.json();

  engine = new Engine(currentTest);
  engine.start();

  // Populate sections
  el.sectionSelect.innerHTML = "";
  currentTest.sections.forEach((s, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = s.title;
    el.sectionSelect.appendChild(opt);
  });

  el.sectionSelect.value = "0";
  engine.sectionIndex = 0;

  loadSectionMaterial(0);
  render();
}

/* ---------------------------
   Render UI
---------------------------- */
function render() {
  const q = engine.currentQuestion();
  renderQuestion(el.question, q, engine);
  updateNav(el.qnav, engine);
  el.status.textContent = engine.progressText();
}

/* ---------------------------
   Events
---------------------------- */
el.sectionSelect.addEventListener("change", () => {
  engine.sectionIndex = Number(el.sectionSelect.value);
  loadSectionMaterial(engine.sectionIndex);
  render();
});

el.prevBtn.addEventListener("click", () => {
  engine.prev();
  render();
});

el.nextBtn.addEventListener("click", () => {
  engine.next();
  render();
});

el.submitBtn.addEventListener("click", () => {
  const result = engine.submit();
  el.results.textContent =
    `Score: ${result.score} / ${result.maxScore}`;
});

el.resetBtn.addEventListener("click", () => {
  if (!currentTest) return;
  engine.reset();
  loadSectionMaterial(engine.sectionIndex);
  render();
});

/* ---------------------------
   Init
---------------------------- */
async function init() {
  const res = await fetch("../data/manifest.json");
  manifest = await res.json();

  el.testSelect.innerHTML = "";
  manifest.reading.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t.path;
    opt.textContent = t.title;
    el.testSelect.appendChild(opt);
  });

  el.testSelect.addEventListener("change", () => {
    loadTest(el.testSelect.value);
  });

  if (manifest.reading.length > 0) {
    el.testSelect.value = manifest.reading[0].path;
    await loadTest(manifest.reading[0].path);
  }
}

init();
